<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>World Map</title>
    <style>
      :root {
        --nav1: #0b1220;
        --nav2: #111b2e;
        --bg: #eef2f7;
        --card: #ffffff;
        --border: #e5e7eb;
        --text: #0f172a;
        --muted: #64748b;
        --shadow: 0 18px 40px rgba(2, 8, 23, 0.1);
        --radius: 16px;
        --radius2: 22px;
        --accent: #0ea5e9;
        --orange: #f97316;
      }

      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          "Segoe UI",
          Roboto,
          "Noto Sans JP",
          "Hiragino Sans",
          "Yu Gothic",
          sans-serif;
        color: var(--text);
        background: linear-gradient(
          180deg,
          var(--nav1) 0%,
          var(--nav1) 120px,
          var(--bg) 120px,
          var(--bg) 100%
        );
      }

      /* --- Layout --- */
      .dash {
        display: flex;
        min-height: 100vh;
        width: 100%;
      }

      /* Sidebar */
      .dash__sidebar {
        width: 260px;
        padding: 22px 16px;
        background: linear-gradient(180deg, var(--nav1), var(--nav2));
        color: #cbd5e1;
        position: sticky;
        top: 0;
        height: 100vh;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 10px 18px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        margin-bottom: 14px;
      }
      .brand__mark {
        width: 34px;
        height: 34px;
        border-radius: 12px;
        background: radial-gradient(circle at 30% 30%, #38bdf8, #2563eb);
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.25);
      }
      .brand__name {
        font-weight: 800;
        color: #e2e8f0;
        line-height: 1.1;
      }
      .brand__sub {
        font-weight: 700;
        color: #94a3b8;
        font-size: 12px;
        margin-top: 2px;
      }

      .snav {
        display: flex;
        flex-direction: column;
        gap: 6px;
        padding: 10px 6px;
      }
      .snav__item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 11px 12px;
        border-radius: 14px;
        text-decoration: none;
        color: #cbd5e1;
        font-weight: 700;
        transition: 0.15s ease;
      }
      .snav__item:hover {
        background: rgba(148, 163, 184, 0.1);
      }
      .snav__item.is-active {
        background: rgba(56, 189, 248, 0.14);
        border: 1px solid rgba(56, 189, 248, 0.18);
        color: #e2e8f0;
      }
      .snav__icon {
        width: 18px;
        display: inline-grid;
        place-items: center;
        opacity: 0.9;
      }
      .snav__spacer {
        height: 10px;
      }

      /* Main */
      .dash__main {
        flex: 1;
        padding: 22px 22px 34px;
      }

      /* Top bar */
      .topbar {
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 6px;
        margin-bottom: 16px;
        color: #e2e8f0;
      }
      .topbar__title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 900;
        letter-spacing: 0.6px;
        text-transform: uppercase;
      }
      .topbar__sep {
        opacity: 0.55;
      }
      .topbar__actions {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .pill {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: #e2e8f0;
        border-radius: 999px;
        padding: 10px 12px;
        font-weight: 800;
      }
      .hamburger {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: #e2e8f0;
        cursor: pointer;
      }
      .hamburger:hover {
        background: rgba(255, 255, 255, 0.14);
      }

      /* Content container */
      .container {
        max-width: 1160px;
        margin: 0 auto;
      }

      /* Grid */
      .grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 18px;
      }

      /* Cards */
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        overflow: hidden;
      }
      .card__head {
        padding: 18px 18px 8px;
        border-bottom: 1px solid rgba(226, 232, 240, 0.7);
      }
      .card__head h3 {
        margin: 0;
        font-size: 14px;
        letter-spacing: 0.6px;
        text-transform: uppercase;
      }
      .card__body {
        padding: 16px 18px 18px;
      }

      /* Big left card internals */
      .scoreRow {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 10px;
      }
      .scoreRow__text {
        color: var(--muted);
        font-size: 13px;
        line-height: 1.5;
        max-width: 520px;
      }
      .scoreRow__badge {
        font-weight: 900;
        color: var(--accent);
        background: #e0f2fe;
        border: 1px solid #bae6fd;
        padding: 6px 10px;
        border-radius: 999px;
        font-size: 12px;
      }

      /* Panels inside cards */
      .panel {
        border: 1px solid rgba(230, 238, 246, 1);
        border-radius: 14px;
        background: linear-gradient(180deg, #fff 0%, #f7fbff 100%);
        padding: 5px 5px 5px;
      }
      .panel--chart {
        margin-top: 10px;
      }
      .axisLabel {
        margin-top: 8px;
        font-size: 12px;
        color: var(--muted);
        font-weight: 800;
        text-align: center;
        letter-spacing: 0.3px;
      }

      /* KPI rings row */
      .kpis {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        margin-top: 14px;
      }
      .kpi {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        min-width: 0;
      }
      .kpi__label {
        font-size: 12px;
        font-weight: 900;
        letter-spacing: 0.6px;
        text-transform: uppercase;
        opacity: 0.9;
        margin-top: -40px;
      }

      /* Right column stacking */
      .rightCol {
        display: grid;
        grid-template-rows: auto auto;
        gap: 18px;
      }
      .people {
        display: grid;
        gap: 12px;
      }
      .person {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 12px;
        border: 1px solid rgba(226, 232, 240, 0.9);
        border-radius: 14px;
        background: linear-gradient(180deg, #fff 0%, #fbfdff 100%);
      }
      .person__left {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 0;
      }
      .avatar {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #38bdf8, #2563eb);
        border: 2px solid rgba(148, 163, 184, 0.25);
        box-shadow: 0 10px 18px rgba(2, 8, 23, 0.08);
        flex: 0 0 auto;
      }
      .avatar--green {
        background: radial-gradient(circle at 30% 30%, #22c55e, #0ea5e9);
      }
      .meta {
        min-width: 0;
      }
      .meta__name {
        font-weight: 900;
        font-size: 14px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .meta__sub {
        margin-top: 4px;
        font-size: 12px;
        font-weight: 800;
        color: var(--muted);
      }
      .person__right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
      }
      .pct {
        font-weight: 900;
        font-size: 18px;
      }
      .tag {
        font-size: 11px;
        font-weight: 900;
        padding: 5px 10px;
        border-radius: 999px;
        letter-spacing: 0.2px;
        border: 1px solid rgba(251, 146, 60, 0.35);
        background: rgba(251, 146, 60, 0.14);
        color: #c2410c;
      }
      .tag--blue {
        border-color: rgba(14, 165, 233, 0.35);
        background: rgba(14, 165, 233, 0.12);
        color: #075985;
      }

      /* Advice section */
      .advice {
        margin-top: 18px;
        border-radius: var(--radius2);
        border: 2px solid rgba(249, 115, 22, 0.25);
        box-shadow: 0 22px 60px rgba(2, 8, 23, 0.12);
        overflow: hidden;
        background: linear-gradient(180deg, #fff 0%, #f7fbff 100%);
      }
      .advice__inner {
        padding: 18px;
      }
      .advice__title {
        text-align: center;
        font-weight: 1000;
        letter-spacing: 0.8px;
        font-size: 24px;
        margin: 6px 0 14px;
      }
      .adviceBox {
        display: grid;
        grid-template-columns: 140px 1fr;
        gap: 18px;
        align-items: center;
        padding: 14px 16px;
        border: 3px solid rgba(249, 115, 22, 0.55);
        border-radius: 22px;
        background: linear-gradient(180deg, #fff 0%, #f1fbff 100%);
      }
      .ceo {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }
      .ceo__avatar {
        width: 78px;
        height: 78px;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #fb923c, #f97316);
        border: 4px solid rgba(249, 115, 22, 0.22);
        box-shadow: 0 12px 20px rgba(2, 8, 23, 0.12);
      }
      .ceo__name {
        font-weight: 900;
        color: #334155;
        letter-spacing: 0.3px;
        font-size: 12px;
      }

      .jp {
        line-height: 1.75;
        font-size: 14px;
        font-weight: 800;
      }
      .jp__lead {
        font-size: 16px;
        font-weight: 1000;
        margin-bottom: 8px;
      }

      .progressRow {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 12px;
      }
      .flame {
        font-size: 18px;
        filter: drop-shadow(0 6px 12px rgba(249, 115, 22, 0.25));
      }

      .cta {
        display: flex;
        justify-content: center;
        margin-top: 12px;
      }
      .btn {
        background: #0f172a;
        color: #fff;
        border: none;
        padding: 12px 22px;
        border-radius: 999px;
        font-weight: 1000;
        letter-spacing: 0.6px;
        cursor: pointer;
        box-shadow: 0 16px 30px rgba(2, 8, 23, 0.18);
      }
      .btn:hover {
        opacity: 0.92;
      }

      /* --- Plotly/Dash embed sizing (重要) --- */
      .embed {
        position: relative;
        min-width: 0;
      }
      .embed--line {
        height: 260px;
      }
      .dpd-embed--ring {
        width: 180px;
        height: 180px;
      }
      .embed--cloud {
        height: 100%;
      }
      .embed--progress {
        height: 44px;
        flex: 1;
      }

      /* どの埋め込みでも中身を100%で満たす */
      .embed iframe,
      .embed .django-plotly-dash,
      .embed .dash-graph,
      .embed .dash-graph > div,
      .embed .js-plotly-plot {
        width: 100% !important;
        height: 100% !important;
        display: block;
        border: 0;
      }

      /* Responsive */
      @media (max-width: 1020px) {
        .dash__sidebar {
          display: none;
        }
        .dash__main {
          padding: 16px;
        }
        .grid {
          grid-template-columns: 1fr;
        }
        .rightCol {
          grid-template-rows: auto;
        }
        .adviceBox {
          grid-template-columns: 1fr;
        }
        .ceo {
          flex-direction: row;
          justify-content: flex-start;
        }
        .advice__title {
          font-size: 20px;
        }
        .kpis {
          grid-template-columns: 1fr;
        }
        .dpd-embed--ring {
          width: 160px;
          height: 160px;
        }
        .kpi__label {
          margin-top: -6px;
        }
      }
      /* 900pxくらいまでは “3つ横” を維持（リングが縮めばOK） */
      @media (max-width: 1020px) {
        .kpis {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }
        .dpd-embed--ring {
          width: 150px;
          height: 150px;
        }
      }

      /* さらに狭い（例：600px以下）なら2列に落とす */
      @media (max-width: 600px) {
        .kpis {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .dpd-embed--ring {
          width: 140px;
          height: 140px;
        }
      }

      /* もっと狭い（例：420px以下）だけ縦1列にする */
      @media (max-width: 420px) {
        .kpis {
          grid-template-columns: 1fr;
        }
        .dpd-embed--ring {
          width: 160px;
          height: 160px;
        }
      }
      /* KPIリング：3等分で等間隔＋中央揃え（このブロックだけのつもりで .kpis に限定） */
      .kpis {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 12px !important;
        justify-items: center !important; /* 各カラムの中で中央に */
        align-items: start !important;
      }

      .kpis .kpi {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        min-width: 0;
      }

      /* リング枠のサイズを“全て同じ”に固定 */
      .kpis .dpd-embed--ring {
        width: 180px !important;
        height: 180px !important;
        position: relative;
      }

      /* ラベルも同じ幅で中央揃え（リング中心と一致させる） */
      .kpis .kpi__label {
        width: 180px !important;
        text-align: center !important;
        margin-top: -40px;
      }

      /* iframe / div を枠いっぱいに（ズレ防止のコア） */
      .kpis .dpd-embed--ring iframe,
      .kpis .dpd-embed--ring .django-plotly-dash,
      .kpis .dpd-embed--ring .dash-graph,
      .kpis .dpd-embed--ring .dash-graph > div,
      .kpis .dpd-embed--ring .js-plotly-plot {
        width: 100% !important;
        height: 100% !important;
        display: block;
        border: 0;
      }
      /* KPI：基本は横3列（等間隔） */
      .kpis {
        display: grid !important;
        grid-template-columns: repeat(3, 1fr) !important;
        gap: 12px !important;
        justify-items: center !important;
        align-items: start !important;
      }

      .kpis .dpd-embed--ring {
        width: 180px !important;
        height: 180px !important;
      }

      /* ✅ スマホ幅だけ縦1列（= 3つ縦並び） */
      @media (max-width: 520px) {
        .kpis {
          grid-template-columns: 1fr !important;
          justify-items: center !important;
        }

        /* スマホでは少し小さくして収まり良く */
        .kpis .dpd-embed--ring {
          width: 160px !important;
          height: 160px !important;
        }

        .kpis .kpi__label {
          width: 160px !important;
          text-align: center !important;
          margin-top: -30px;
        }
      }

      /* スマホ時：縦を少し増やして “小さく見える” を解消 */
      @media (max-width: 520px) {
        /*.embed--line {
          height: 320px; /* ←スマホは少し縦を増やすと見やすい */
        /* }*/

        /* グラフカードの余白も削る（container/card側にpaddingがある場合） */
        .panel--chart,
        .chart {
          padding: 6px 6px 8px !important;
        }
      }
      .progress-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 12px;
      }
      .flame {
        font-size: 18px;
        filter: drop-shadow(0 6px 12px rgba(249, 115, 22, 0.25));
      }
      .bar {
        flex: 1;
        height: 10px;
        border-radius: 999px;
        background: #e5e7eb;
        overflow: hidden;
        position: relative;
        box-shadow: inset 0 0 0 1px rgba(226, 232, 240, 0.9);
      }
      .bar > i {
        display: block;
        height: 100%;
        width: 85%;
        background: linear-gradient(90deg, #38bdf8, #0ea5e9);
        border-radius: 999px;
      }
      .pct-big {
        font-weight: 1000;
        font-size: 22px;
        color: #0f172a;
        min-width: 70px;
        text-align: right;
      }
      .cta {
        display: flex;
        justify-content: center;
        margin-top: 12px;
      }
      /* 埋め込み枠 */
      .dpd-embed {
        position: relative;
      }

      /* ロード完了まで iframe を隠す（これで透過しても下の loading が見えない） */
      .dpd-embed:not(.is-loaded) iframe {
        visibility: hidden !important;
      }

      /* ローディングオーバーレイ（完全に隠したいなら不透明にする） */
      .dpd-loader {
        position: absolute;
        inset: 0;
        z-index: 2;
        display: grid;
        place-items: center;

        /* ★透過度をやめる（下の loading を絶対に見せない） */
        background: #ffffff;

        /* もし雰囲気は残したいなら↓みたいに“ほぼ不透明”にする
  background: rgba(255,255,255,0.95);
  */

        border-radius: 14px;
      }

      /* スピナー本体：灰色リングなし（青い弧だけ） */
      .dpd-loader::after {
        content: "";
        width: 44px;
        height: 44px;
        border-radius: 999px;

        /* ★灰色のベースを消す */
        border: 4px solid transparent;

        /* ★見せたい部分だけ色を付ける */
        border-top-color: #0ea5e9;

        animation: dpdspin 0.9s linear infinite;

        /* 必要なら影も消せます */
        box-shadow: none;
      }

      @keyframes dpdspin {
        to {
          transform: rotate(360deg);
        }
      }

      /* 読み込み完了したらオーバーレイ消す */
      .dpd-embed.is-loaded .dpd-loader {
        display: none !important;
      }
      .dpd-embed--cloud {
        width: 100%;
        height: 100%; /* 好きな高さに */
      }
      @media (max-width: 520px) {
        .dpd-embed--cloud {
          height: 100%;
        }
      }
      .dpd-embed--line {
        width: 100%;
        height: 260px;
      }
      @media (max-width: 520px) {
        .dpd-embed--line {
          height: 260px;
        }
      }
    </style>
    <!-- <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
      integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk"
      crossorigin="anonymous"
    /> -->
  </head>
  <body>
    {% block content %} {% endblock %}

    <script
      src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
      integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
      integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
      crossorigin="anonymous"
    ></script>
    <script>
      (function () {
        function isRendered(doc) {
          // Plotlyが描画されたか（リング/折れ線など）
          const plot = doc.querySelector(".js-plotly-plot");
          if (
            plot &&
            plot.querySelector(".plot-container, .svg-container, canvas")
          )
            return true;

          // WordCloud等のImgが描画されたか
          const img = doc.querySelector("img");
          if (img && img.complete && img.naturalWidth > 0) return true;

          // Dashのrootができてるだけでは早いので、ここまでで判定
          return false;
        }

        function markLoaded(wrap) {
          wrap.classList.add("is-loaded");
        }

        function waitForReady(iframe, wrap, timeoutMs = 15000) {
          const start = Date.now();

          (function tick() {
            let doc = null;
            try {
              doc = iframe.contentDocument;
            } catch (e) {
              doc = null;
            }

            if (doc && isRendered(doc)) {
              markLoaded(wrap);
              return;
            }

            // タイムアウト保険（ずっと消えないのを防ぐ）
            if (Date.now() - start > timeoutMs) {
              markLoaded(wrap);
              return;
            }

            setTimeout(tick, 200);
          })();
        }

        function bindWrap(wrap) {
          const findIframe = () => wrap.querySelector("iframe");

          const tryBind = () => {
            const iframe = findIframe();
            if (!iframe) return;

            if (iframe.__dpdBound) return;
            iframe.__dpdBound = true;

            // load が来なくてもポーリングで拾う
            iframe.addEventListener("load", () => waitForReady(iframe, wrap), {
              once: false,
            });

            // 既に読み込み途中/完了の可能性もあるので即ポーリング開始
            waitForReady(iframe, wrap);
          };

          // 初回
          tryBind();

          // 後から iframe が差し替わるケースに備えて監視
          const mo = new MutationObserver(() => tryBind());
          mo.observe(wrap, { childList: true, subtree: true });
        }

        document.addEventListener("DOMContentLoaded", () => {
          document.querySelectorAll("[data-dpd-loader]").forEach(bindWrap);
        });
      })();
    </script>
  </body>
</html>
